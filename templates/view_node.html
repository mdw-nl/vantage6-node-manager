{% extends "base.html" %}

{% block title %}{{ config.name }} - Vantage6 Node Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="bi bi-server"></i> {{ config.name }}
                <span class="status-badge status-{{ config.status }}">
                    {% if config.status == 'running' %}
                        <i class="bi bi-play-fill"></i> Running
                    {% elif config.status == 'stopped' %}
                        <i class="bi bi-stop-fill"></i> Stopped
                    {% else %}
                        <i class="bi bi-question-circle"></i> Unknown
                    {% endif %}
                </span>
            </h1>
            <a href="{{ url_for('list_nodes') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to List
            </a>
        </div>
    </div>
</div>

<!-- Control Buttons -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="btn-group me-2" role="group">
                    {% if config.status == 'running' %}
                    <form method="POST" action="{{ url_for('stop_node', name=config.name) }}" style="display: inline;">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-stop-fill"></i> Stop Node
                        </button>
                    </form>
                    <form method="POST" action="{{ url_for('restart_node', name=config.name) }}" style="display: inline;">
                        <button type="submit" class="btn btn-warning">
                            <i class="bi bi-arrow-clockwise"></i> Restart Node
                        </button>
                    </form>
                    <button class="btn btn-info" onclick="refreshLogs()">
                        <i class="bi bi-arrow-clockwise"></i> Refresh Logs
                    </button>
                    {% else %}
                    <form method="POST" action="{{ url_for('start_node', name=config.name) }}" style="display: inline;">
                        <input type="hidden" name="image" value="harbor2.vantage6.ai/infrastructure/node:4.7.1">
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-play-fill"></i> Start Node
                        </button>
                    </form>
                    {% endif %}
                </div>
                
                <div class="btn-group" role="group">
                    <form method="POST" action="{{ url_for('delete_node', name=config.name) }}" 
                          onsubmit="return confirm('Are you sure you want to delete this node configuration? This action cannot be undone.');"
                          style="display: inline;">
                        <button type="submit" class="btn btn-outline-danger" {% if config.status == 'running' %}disabled{% endif %}>
                            <i class="bi bi-trash"></i> Delete Configuration
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Configuration Details -->
    <div class="col-lg-6">
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-info-circle"></i> Configuration Details
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Name:</dt>
                    <dd class="col-sm-8"><strong>{{ config.name }}</strong></dd>
                    
                    <dt class="col-sm-4">Type:</dt>
                    <dd class="col-sm-8">
                        <span class="badge bg-{{ 'primary' if config.type == 'system' else 'secondary' }}">
                            {{ config.type }}
                        </span>
                    </dd>
                    
                    <dt class="col-sm-4">Config File:</dt>
                    <dd class="col-sm-8"><code>{{ config.path }}</code></dd>
                    
                    <dt class="col-sm-4">Server URL:</dt>
                    <dd class="col-sm-8">
                        <a href="{{ config.data.server_url }}" target="_blank">
                            {{ config.data.server_url }}
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </dd>
                    
                    {% if config.data.port %}
                    <dt class="col-sm-4">Port:</dt>
                    <dd class="col-sm-8">{{ config.data.port }}</dd>
                    {% endif %}
                    
                    <dt class="col-sm-4">API Path:</dt>
                    <dd class="col-sm-8"><code>{{ config.data.api_path }}</code></dd>
                    
                    {% if config.data.task_dir %}
                    <dt class="col-sm-4">Task Directory:</dt>
                    <dd class="col-sm-8"><code>{{ config.data.task_dir }}</code></dd>
                    {% endif %}
                    
                    <dt class="col-sm-4">Encryption:</dt>
                    <dd class="col-sm-8">
                        {% if config.data.encryption.enabled %}
                            <span class="badge bg-success">Enabled</span>
                        {% else %}
                            <span class="badge bg-secondary">Disabled</span>
                        {% endif %}
                    </dd>
                </dl>
            </div>
        </div>

        <!-- Database Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-database"></i> Database Configuration
            </div>
            <div class="card-body">
                {% if config.data.databases %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Label</th>
                                <th>Type</th>
                                <th>URI</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for db in config.data.databases %}
                            <tr>
                                <td><strong>{{ db.label }}</strong></td>
                                <td><span class="badge bg-info">{{ db.type }}</span></td>
                                <td><code>{{ db.uri }}</code></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted mb-0">No databases configured.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Container Information & Logs -->
    <div class="col-lg-6">
        {% if container_info %}
        <div class="card mb-4">
            <div class="card-header">
                <i class="bi bi-box"></i> Container Information
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Container ID:</dt>
                    <dd class="col-sm-8"><code>{{ container_info.id }}</code></dd>
                    
                    <dt class="col-sm-4">Image:</dt>
                    <dd class="col-sm-8"><code>{{ container_info.image }}</code></dd>
                    
                    <dt class="col-sm-4">Created:</dt>
                    <dd class="col-sm-8">{{ container_info.created }}</dd>
                    
                    {% if container_info.ports %}
                    <dt class="col-sm-4">Ports:</dt>
                    <dd class="col-sm-8">
                        {% for port, bindings in container_info.ports.items() %}
                            {{ port }}
                            {% if bindings %}
                                â†’ {{ bindings[0].HostPort }}
                            {% endif %}
                            <br>
                        {% endfor %}
                    </dd>
                    {% endif %}
                </dl>
            </div>
        </div>
        {% endif %}

        <!-- Logs -->
        {% if config.status == 'running' %}
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-file-text"></i> Container Logs</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body">
                <pre id="logs" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa; padding: 1rem; border-radius: 0.25rem;">
Loading logs...
                </pre>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-stop-circle" style="font-size: 3rem; color: #dee2e6;"></i>
                <h5 class="mt-3">Node is not running</h5>
                <p class="text-muted">Start the node to view logs</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    function refreshLogs() {
        fetch("{{ url_for('view_logs', name=config.name) }}")
            .then(response => response.json())
            .then(data => {
                if (data.logs) {
                    document.getElementById('logs').textContent = data.logs;
                } else if (data.error) {
                    document.getElementById('logs').textContent = 'Error: ' + data.error;
                }
            })
            .catch(error => {
                document.getElementById('logs').textContent = 'Error fetching logs: ' + error;
            });
    }

    // Auto-refresh logs every 5 seconds if node is running
    {% if config.status == 'running' %}
    setInterval(refreshLogs, 5000);
    // Load logs immediately
    refreshLogs();
    {% endif %}
</script>
{% endblock %}
